"""Computes pairwise distances.

Currently, 'cdist()' function from scipy is the fastest, although it uses only
one core. Using np.sum(np.power(dist,2),2) is 10x slower.
"""
from ibc_config import IBCConfig as cf
import cPickle
import numpy as np
import os
import scipy.spatial.distance as distance


class PDist(object):
    """Implementation of pairwise distance calculation.

    Distance function is set to squared euclidean. No results for
    other functions yet, but they can do as well.

    Eats something like 30% of the total image classification time.
    Fast parallel BLAS or GPU implementation would be beneficial.
    """

    def __init__(self):
        """Initialize object with constant centroids.
        """        
        if os.isfile(cf._C_file):
            self.C = cPickle.load(open(cf._C_file, "rb"))
        else:  
            # centroids have not been initialized yet
            self.C = 0


    def get_nn(self, D):
        """Get indices of the first nearest neighbours.
        
        Transferring back indices only is faster that
        the whole distance matrix.
        """
        if self.C == 0:
            return "Uninitialized centroids"
        
        dist = distance.cdist(D, self.C, 'sqeuclidean')
        inds = np.argsort(dist, 1, 'ascending')
        l = range(len(inds))
        dsts = dist[l, inds]
        return (inds, dsts)

